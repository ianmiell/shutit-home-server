# We assert here that we are running as root
SEND whoami
ASSERT_OUTPUT root

# We assert here the user imiell was set up by the OS installation process
SEND cut -d: -f1 /etc/passwd | grep imiell | wc -l
ASSERT_OUTPUT 1

# Install required packages
INSTALL docker.io
INSTALL openssh-server
INSTALL run-one
INSTALL apache2
INSTALL vim
INSTALL python-pip
INSTALL meld
INSTALL tmux
INSTALL docker-compose
INSTALL openjdk-8-jre
INSTALL alien
INSTALL brasero
INSTALL virtualbox
INSTALL moreutils
INSTALL git
INSTALL git-extras
INSTALL npm
INSTALL nodejs-legacy
INSTALL asciidoc
INSTALL awscli
INSTALL python3-pip
RUN npm install -g mermaid
RUN pip install --upgrade pip

# Install ShutIt, naturally
RUN pip install shutit
# Add imiell to the docker user group
RUN usermod -G docker -a imiell 

# Pull my dev tools image from Dockerhub
RUN docker pull imiell/docker-dev-tools-image

# Set up local storage
RUN mkdir -p /media/storage_{1,2}

# Create space folder and chown it to imiell
RUN mkdir -p /space && chown imiell: /space
RUN mkdir -p /space/git

# Asciidoc
# asciidoctor pdf
RUN gem install --pre asciidoctor-pdf
RUN gem install coderay pygments.rb

# Generate an ssh key
RUN ssh-keygen
# Note that the response to 'already exists' below prevents overwrite here.
EXPECT_MULTI ['file in which=','empty for no passphrase=','Enter same passphrase again=','already exists=n']

# Apache
RUN a2enmod proxy
RUN a2enmod proxy_http
RUN a2enmod proxy_ajp
RUN a2enmod rewrite
RUN a2enmod deflate
RUN a2enmod headers
RUN a2enmod proxy_balancer
RUN a2enmod proxy_connect
RUN a2enmod proxy_html

# Vagrant 1.8.6 required
RUN wget https://releases.hashicorp.com/vagrant/1.8.6/vagrant_1.8.6_x86_64.deb
RUN dpkg -i vagrant_1.8.6_x86_64.deb
RUN rm vagrant_1.8.6_x86_64.deb

# Log me in as imiell
USER imiell
# If it's not been done before, check out my dotfiles and set it up
IF_NOT FILE_EXISTS /home/imiell/.dotfiles
	RUN cd /home/imiell
	RUN git clone --depth=1 https://github.com/ianmiell/dotfiles ~imiell/.dotfiles
	RUN cd .dotfiles
	RUN ./script/bootstrap
	EXPECT_MULTI ['What is your github author name=Ian Miell','What is your github author email=ian.miell@gmail.com','verwrite=O']
ENDIF

# Git repos
RUN cd /space/git
RUN wget -qO- https://api.github.com/users/ianmiell/repos?per_page=1000 | grep full_name  | awk '{print $2}' | sed 's/^.\(.*\)",/git clone --recursive https:\/\/github.com\/\1/' | sh

#https://ubuntuforums.org/showthread.php?t=1842371 - speed up login
RUN sed -i 's/hosts:.*NOTFOUND.*/hosts: files dns/' /etc/nsswitch.conf

LOGOUT

